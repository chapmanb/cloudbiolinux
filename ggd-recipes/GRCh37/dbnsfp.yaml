---
attributes:
  name: dbnsfp
  version: 4.0a
recipe:
  full:
    recipe_type: bash
    recipe_cmds:
      - |
        # Uses Google Drive for faster download with tricks from
        # http://stackoverflow.com/a/38937732/252589
        ggID='1BNLEdIc4CjCeOa7V7Z8n8P8RHqUaF5GZ'
        ggURL='https://drive.google.com/uc?export=download'
        mkdir -p variation
        cd variation
        filename="$(curl -k -sc tmp-gcokie "${ggURL}&id=${ggID}" | grep -o '="uc-name.*</span>' | sed 's/.*">//;s/<.a> .*//')"
        getcode="$(awk '/_warning_/ {print $NF}' tmp-gcokie)"
        curl -k -Lb tmp-gcokie "${ggURL}&confirm=${getcode}&id=${ggID}" -o "${filename}" -C -
        UNPACK_DIR=`pwd`/tmpunpack
        if [ ! -f dbNSFP.txt.gz ]; then
          mkdir -p $UNPACK_DIR
          unzip dbNSFP*.zip "dbNSFP*_variant.chr*.gz" -d $UNPACK_DIR
          zcat $UNPACK_DIR/dbNSFP*_variant.chrM.gz | head -n1 > $UNPACK_DIR/header.txt
          # unzip only files with chromosomal info, eg. skip genes and readme.
          # b37 parsing logic sourced from Ensembl https://github.com/Ensembl/VEP_plugins/blob/master/dbNSFP.pm
          zcat $UNPACK_DIR/dbNSFP*_variant.chr*.gz \
          | grep -v '^#chr' \
          | awk '$8 != "."'
          | sort -T $UNPACK_DIR -k8,8 -k9,9n - \
          | cat $UNPACK_DIR/header.txt - \
          | bgzip -c > dbNSFP.txt.gz
          #extract readme file, used by VEP plugin to add vcf header info
          unzip -p dbNSFP*.zip "*readme.txt" > dbNSFP.readme.txt
        fi
        # index in position 1 and 2
        tabix -f -s 8 -b 9 -e 9 -c '#' dbNSFP.txt.gz
        tabix -f -s 8 -b 9 -e 9 -c '#' --csi dbNSFP.txt.gz
        rm -rf $UNPACK_DIR
        rm -f tmp-gcokie
        rm -f dbNSFPv*.zip
    recipe_outfiles:
      - variation/dbNSFP.txt.gz
      - variation/dbNSFP.txt.gz.tbi
      - variation/dbNSFP.txt.gz.csi
      - variation/dbNSFP.readme.txt
